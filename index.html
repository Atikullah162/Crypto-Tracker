<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Tracker — Stylish</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Recharts -->
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">

<main class="max-w-6xl mx-auto p-4">
  <div id="app"></div>
  <div id="watchlist" class="mt-6"></div>
</main>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;
const { LineChart, Line, ResponsiveContainer } = Recharts;

// Use CoinGecko public API (no key needed)
const API = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=true';

function formatUSD(n) {
  const v = Number(n);
  if (!isFinite(v)) return '-';
  return v >= 1 ? v.toLocaleString(undefined, { style:'currency', currency:'USD', maximumFractionDigits:2 })
                : v.toLocaleString(undefined, { style:'currency', currency:'USD', maximumFractionDigits:6 });
}

function Sparkline({ data }) {
  const prices = data?.sparkline_in_7d?.price?.slice(-24) ?? [];
  if (!prices.length) return null;
  const first = prices[0], last = prices[prices.length-1];
  const up = last >= first;
  const chartData = prices.map(p => ({ p }));
  return (
    <div style={{ width: 120, height: 32 }}>
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={chartData}>
          <Line type="monotone" dataKey="p" dot={false} strokeWidth={2} stroke={up ? '#34d399' : '#f87171'} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}

function App() {
  const [coins, setCoins] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [watchlist, setWatchlist] = useState(() => {
    try { return JSON.parse(localStorage.getItem('watchlist')) || []; } catch { return []; }
  });

  useEffect(() => {
    async function fetchData() {
      try {
        const res = await fetch(API);
        const data = await res.json();
        setCoins(data);
      } catch (err) {
        console.error('Error fetching data', err);
      } finally {
        setLoading(false);
      }
    }
    fetchData();
    const interval = setInterval(fetchData, 30000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
  }, [watchlist]);

  const filtered = useMemo(() => {
    const q = search.toLowerCase();
    return coins.filter(c => c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q));
  }, [coins, search]);

  const toggleWatch = coin => {
    setWatchlist(prev => prev.some(c => c.id === coin.id) 
      ? prev.filter(c => c.id !== coin.id) 
      : [...prev, coin]);
  };

  if (loading) return <div className="text-center text-gray-400 mt-20">Loading coins…</div>;

  return (
    <div>
      <div className="flex mb-4">
        <input 
          type="text" 
          placeholder="Search by name or symbol" 
          className="flex-1 p-2 rounded-md text-gray-900" 
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-gray-800 rounded-lg p-4 shadow-lg">
          <h2 className="text-lg font-bold mb-2">Top Coins</h2>
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="border-b border-gray-600">
                <tr>
                  <th className="px-2 py-1">#</th>
                  <th className="px-2 py-1">Name</th>
                  <th className="px-2 py-1">Price</th>
                  <th className="px-2 py-1">24h</th>
                  <th className="px-2 py-1">Spark</th>
                  <th className="px-2 py-1">⭐</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((c, i) => {
                  const up = c.price_change_percentage_24h >= 0;
                  const inWatch = watchlist.some(w => w.id === c.id);
                  return (
                    <tr key={c.id} className="hover:bg-gray-700 transition">
                      <td className="px-2 py-1">{i+1}</td>
                      <td className="px-2 py-1 flex items-center gap-2">
                        <img src={c.image} alt="" className="w-6 h-6 rounded-full" />
                        {c.name} <span className="text-gray-400 uppercase text-xs">{c.symbol}</span>
                      </td>
                      <td className="px-2 py-1">{formatUSD(c.current_price)}</td>
                      <td className={`px-2 py-1 ${up ? 'text-green-400' : 'text-red-400'}`}>
                        {up ? '▲' : '▼'} {Math.abs(c.price_change_percentage_24h).toFixed(2)}%
                      </td>
                      <td className="px-2 py-1"><Sparkline data={c} /></td>
                      <td className="px-2 py-1 cursor-pointer" onClick={() => toggleWatch(c)}>
                        {inWatch ? '⭐' : '☆'}
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-gray-800 rounded-lg p-4 shadow-lg">
          <h2 className="text-lg font-bold mb-2">Watchlist</h2>
          {watchlist.length === 0 
            ? <p className="text-gray-400">Add coins by clicking ⭐</p>
            : watchlist.map(c => (
              <div key={c.id} className="flex justify-between items-center mb-2 p-2 bg-gray-700 rounded-md">
                <span>{c.name} ({c.symbol.toUpperCase()})</span>
                <span>{formatUSD(c.current_price)}</span>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('app'));
</script>

</body>
</html>
